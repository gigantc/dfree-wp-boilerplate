#!/usr/bin/env node

/**
 * Generate _blocks.scss from all block SCSS partials
 * Replaces the Gulp generateBlocksScssTask
 */

const fs = require('fs');
const path = require('path');

const blocksDir = path.join(__dirname, '../blocks');
const outputFile = path.join(__dirname, '../src/scss/_blocks.scss');

/**
 * Recursively find all SCSS partials in blocks directory
 */
function findScssPartials(dir) {
  let forwards = [];

  const entries = fs.readdirSync(dir, { withFileTypes: true });

  for (const entry of entries) {
    const entryPath = path.join(dir, entry.name);

    if (entry.isDirectory()) {
      forwards.push(...findScssPartials(entryPath));
    } else if (
      entry.isFile() &&
      entry.name.startsWith('_') &&
      entry.name.endsWith('.scss')
    ) {
      const relative = path.relative(path.join(__dirname, '../src/scss'), entryPath);
      const cleaned = relative
        .replace(/^_/, '')         // Remove underscore
        .replace(/\.scss$/, '')    // Remove .scss
        .replace(/\\/g, '/');      // Normalize Windows slashes

      forwards.push(`@forward '${cleaned}';`);
    }
  }

  return forwards;
}

// Generate the file
const lines = findScssPartials(blocksDir);
const headerComment = `// This file is auto-generated by npm run blocks:generate
// Do not edit this file directly—any changes will be overwritten.\n\n`;

fs.writeFileSync(outputFile, headerComment + lines.join('\n') + '\n');

console.log(`✅ Updated _blocks.scss with ${lines.length} entries`);
